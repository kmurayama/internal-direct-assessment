---
title: "Note to Inspect Rubric Data 7"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_notebook:
    toc: yes
    toc_float:
      collapsed: yes
    code_folding: hide
  html_document:
    toc: yes
    toc_float:
      collapsed: no
    df_print: paged
    code_folding: hide
    fig_height: 7
    fig_width: 7
---

```{r, echo=FALSE, include=FALSE}
#knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(tidyverse)
options(dplyr.summarise.inform=FALSE) 
library(readxl)
```

Objective
================================================================================
Data are mostly cleaned and organized; PLOs are largely matched for Standard 4
reporting; yet, there are several critically missing pieces. 1) Present the
outcomes for those which are present and 2) sort out the current situation and
follow up with faculty/staff for missing information (i.e. missing data,
assessments, and mappings).



Set up
================================================================================
Import data. Codes are externalized for reuse. As a reference:

- `mdf` or main data frame contains the rubric outcome data merged with the course/assessment information gathered from the survey. Data are cleaned up.
- `non` or non-rubric data frame is separated from the same data source as the
rubric information of `mdf`. It contains the instructor's assessments of
outcomes at course level. Data are cleaned up.
- `past` data frame contains the assessment outcome data from the past.
- `rowmap` data frame summarizes the mapping between PLOs and rubric rows.

```{r}
source('read.R')
source('munge.R')
```
Those scripts have been updated to use the *edited* version of the survey result
data. See Note 5 for details. Given that change, the Notebooks 1-5 are
completely outdated.

New Issues
--------------------------------------------------------------------------------
New things in this note:

- [x] Drop BUS 499 GW1 Spring 2020 Annotated Bibliography from data, while adding the observed into non-rubric
- [x] Drop ECO 421 001 from data, while adding the observed into non-rubric
- [x] Drop HRM 400 001 from data, while adding the observed into non-rubric

```{r}
mdf.original <- mdf
mdf <- mdf %>%
  filter(!( (Section == "BUS 499 GW1" & Semester == "Spring 2020" & Assessment == "Annotated Bibliography") |
             Section == "ECO 421 001" | Section == "HRM 400 001"))
```



PLO Measures for Standard 4
================================================================================
Overview
--------------------------------------------------------------------------------
For Standard 4, we only need a rather small subset of the assessments available. Produce the summary of outcomes in the context of historical changes. 

- ACBSP requires 3-5 data points, so make sure to have sufficient numbers.
- ACBSP requires graphs with sample sizes.
- Nuventive requires numbers. Produce data tables along with the graphs.

Once Standard 4 is done, we can discuss weakness/shortcomings and
strength/improvements in our program, then look at other courses - including the
ones at an earlier stage of each program - to find *opportunities for
improvement* and *close the loop*. That is, we can get to **Standard 6**
analysis.


Summarize Outcomes
--------------------------------------------------------------------------------
For this academic year, we have assessments both with and without rubrics. In the following, I summarize the rubric-based assessments - observed at individual level - at `Section` level, then combine them with the non-rubric-based assessments - observed at `Section` level. Then, the summarized data will be aggregated to `Course` level.

```{r}
tbl1 <- mdf %>% filter(str_detect(Name, "Major|Minor", negate = TRUE)) %>%
  group_by(Course, Section, Semester, Assessment, Name, PLO) %>%
  summarise(Met.UND = mean(Met.UND.bin), Met.GRD = mean(Met.GRD.bin),
            n = n_distinct(UserId)) %>% 
  mutate(Rubric = TRUE)

tbl2 <- non %>% transmute(Course, Section, Semester, Assessment, Name = "NA", PLO, Met.UND = np/n, Met.GRD = Met.UND, n, Rubric = FALSE)

tbl3 <- bind_rows(tbl1, tbl2)
```
Add scraped data into the table.
```{r}
x <- tibble(Course = c(rep("HRM 400", 3), "BUS 499", rep("ECO 421", 3)), 
            Section = c(rep("HRM 400 001", 3), "BUS 499 GW1", rep("ECO 421 001", 3)), 
            Semester = c(rep("Spring 2020", 4), rep("Fall 2019", 3)),
            Assessment = c(paste("Paper", 1:3), "Annotated Bibliography", paste("Final Paper", 1:3)),
            Name = rep("Retrieved", 7),
            PLO = c(paste("HRM", 1:3), "BUS 2", rep("ECO 3, ECO 4, ECO 5", 3)),
            Met.UND = c(0.35, 0.57, 0.73, 0.87, 0.91, 0.91, 0.82),
            Met.GRD = c(0.35, 0.57, 0.73, 0.87, 0.91, 0.91, 0.82),
            n = c(rep(14, 3), 15, rep(11, 3)),
            Rubric = TRUE
            )
x
tbl3 <- bind_rows(tbl3, x)
```

Aggregate over `Course` over `Section` and `Semester`. Average needs to be weighted by the size of each section.
```{r}
tbl4 <- tbl3 %>%
  group_by(Course, Assessment, PLO, Name) %>%
  summarise(Met.UND = weighted.mean(Met.UND, n, na.rm = TRUE),
            Met.GRD = weighted.mean(Met.GRD, n, na.rm = TRUE),
            n = sum(n, na.rm = TRUE), n.sec = n_distinct(Section))
```

New Issues Follow Up
--------------------------------------------------------------------------------
```{r}
tbl4 %>% filter(PLO == "BUS 2", str_detect(Name, "(Plo2)|(Retrieved)"))
```


```{r}
tbl4 %>% filter(PLO == "BUS 2", str_detect(Name, "(Plo2)|(Retrieved)")) %>% ungroup() %>% summarize(Met = mean(Met.UND, na.rm = TRUE), n = min(n))
```

That's wrong. One has 43 students (in 3 sections) and the other has 15 (in 1 section), then n should be 58. But I can't simply add them up to avoid double count.
 Aggregation at `tbl4` introduced another inconsistency. Ones from `tbl1` is in `Section`-`Assessment`-`Name`, while ones from `tbl2` is in `Section` (no disaggregation of assessment or rubric rows). 
Not problematic for `HRM 400` and `ECO 421` because their observations are entirely replaced. For `BUS 499 GW1`, I can enter each rubric row.


Another issue is found in MBA. Since I distinguished summative/formative, it picks up both and make the graph messed up. I can solve this by making yet another source with only relevant past data... or add a switch for summative/formative.


- [ ] Enter each row of BUS 499
- [ ] Deal with varying goals
- [ ] Deal with summative/formative objectives

Prepare
--------------------------------------------------------------------------------
```{r}
get_outcome <- function(plotag, rrow, program, plo, grad = FALSE){
  if(is.na(rrow)){return(tibble(n = NA, Program = program, Met = NA, PLO = plo))}
  if(grad){
    tbl4 %>% filter(PLO == plotag, str_detect(Name, rrow)) %>% ungroup() %>% 
      summarize(Met = mean(Met.GRD), n = min(n)) %>%
      mutate(Program = program, PLO = plo)
  }
  else{
    tbl4 %>% filter(PLO == plotag, str_detect(Name, rrow)) %>% ungroup() %>% 
      summarize(Met = mean(Met.UND), n = min(n)) %>%
      mutate(Program = program, PLO = plo)
  }
}
#get_outcome(plotag = "ACC 1", rrow = "NA",
#            program = "Accounting", plo = 5)
```

```{r}
#levels(factor(tbl3$PLO))
list.plotags <- list(
  "Accounting" = c("ACC 1", "ACC 2", NA, "ACC 4"),
  "Business Core" = c(NA, "BUS 2", "BUS 3, BUS 5, BUS 6", "BUS 4, BUS 9",
                      "BUS 3, BUS 5, BUS 6", "BUS 3, BUS 5, BUS 6",
                      "BUS 7, BUS 8", "BUS 7, BUS 8", "BUS 4, BUS 9",
                      "BUS 10"),
  "Economics" = c(NA, "ECO 2", rep("ECO 3, ECO 4, ECO 5", 3)),
  "Human Resources Management" = paste("HRM", 1:4),
  "Management" = c(rep("MGT 1, MGT 2, MGT 3", 3), "MGT 4"),
  "MBA" = c(paste("MBA", 1:4), NA, paste("MBA", 6:8))
  )
list.rrows <- list(
  "Accounting" = c(rep("NA", 2), NA, "NA"),
  "Business Core" = c(NA, "(Plo2)|(Retrieved)", "Plo3", "Plo4", "5[a|b|c|d]", "6[e|f|g]",
                      "Plo7", "Plo8", "Plo9", ".*"),
  "Economics" = c(NA, ".*", ".*", "(Literature Review)|(Retrieved)", "(Discussion Of Empirical Results)|(Retrieved)"),
  "Human Resources Management" = c("(Organizational Types)|(Retrieved)",
           "(Organizational Types)|(Organizational Strategy)|(Retrieved)",
           "(Hr Law)|(Retrieved)", ".*"),
  "Management" = c("Plo1", "Plo5", "Plo7", ".*"),
  "MBA" = rep(".*", 8)
  )
list.goals <- list(
  "Accounting" = rep(0.7, 4),
  "Business Core" = c(rep(0.7, 8), 0.9, 0.7),
  "Economics" = rep(0.7, 5),
  "Human Resources Management" = rep(0.7, 4),
  "Management" = rep(0.7, 4),
  "MBA" = rep(0.85, 8)
)
# MIS, MKT
```

```{r}
get_outcomes <- function(program, grad = FALSE){
  # Wrapper to return a combined results for each program
  lres <- list()
  plotags <- list.plotags[[program]]
  rrows <- list.rrows[[program]]
  for(i in 1:length(plotags)){
    lres[[i]] <- get_outcome(plotags[i], rrows[i], program, i, grad)
  }
  lres
}

merge_outcomes <- function(lres, program){
  # Wrapper function to merge with the historical assessment results
  #lres <- lres[!is.na(lres)] # Missing assessment returns NA
  x <- bind_rows(lres)
  x <- x %>% ungroup() %>%
    transmute(`Learning Objective Number` = PLO,
              `Academic Year` = rep(2019, nrow(x)),
              `Outcome` = Met, `Sample Size` = n, `Outcome Goal` = list.goals[[program]])
  
  y <- past %>%
    filter(Program == program, `Assessment Type Orientation` == "Internal") %>% 
    select(`Learning Objective Number`, `Academic Year`,
           Outcome, `Sample Size`, `Outcome Goal`)
  out <- bind_rows(x, y)
  out %>% arrange(`Learning Objective Number`, `Academic Year`)
}

getmerge_outcomes <- function(program, grad = FALSE){
  lres <- get_outcomes(program, grad)
  merge_outcomes(lres, program)
}

#getmerge_outcomes("Accounting")
#past %>% filter(Program == "MBA", str_detect(`Assessment Type`, "(Internal$)|(Internal Formative)"))
```

```{r}
make_graph <- function(df.out, program){
  title <- paste0(program, ", Prevalence of Achievments Over Academic Years, by PLO")
  caption <- "Grey number represents sample size.\nFor 2019, minimum sample size is used if prevalence is computed from multiple criteria."
  ymin <- min(min(df.out$Outcome, na.rm = TRUE),
              min(df.out$`Outcome Goal` - 0.1, na.rm = TRUE))
  
  p <- ggplot(df.out, aes(x = `Academic Year`, y = Outcome,
                          group = `Learning Objective Number`)) +
    geom_line(na.rm = TRUE) +
    geom_point(aes(color = Outcome > `Outcome Goal`), na.rm = TRUE) +
    scale_colour_manual(values = setNames(c('blue','red'),c(T, F))) +
    geom_text(aes(`Academic Year`, 0.65, label = round(`Sample Size`, 0)),
              alpha = 0.4, na.rm = TRUE) +
    geom_hline(aes(yintercept = `Outcome Goal`), alpha = 0.4, color = "red") +
    scale_y_continuous(labels=scales::percent,
                       breaks = seq(0, 1, 0.2), limits = c(ymin, 1))
  p + facet_wrap(vars(`Learning Objective Number`)) +
    theme_minimal() +
    labs(title = title, caption = caption) +
    theme(axis.title = element_blank(),
          text = element_text(family = "serif"),
          panel.grid.minor.x = element_blank(),
          legend.position = "none")
}
```


Outcomes
================================================================================
Accounting
--------------------------------------------------------------------------------
```{r}
acc <- getmerge_outcomes("Accounting")
make_graph(acc, "Accounting")
```

Business Core
--------------------------------------------------------------------------------
```{r}
bus <- getmerge_outcomes("Business Core")
make_graph(bus, "Business Core")
```

Economics
--------------------------------------------------------------------------------
```{r}
eco <- getmerge_outcomes("Economics")
make_graph(eco, "Economics")
```

Finance
--------------------------------------------------------------------------------

Human Resources Management
--------------------------------------------------------------------------------
```{r}
hrm <- getmerge_outcomes("Human Resources Management")
make_graph(hrm, "Human Resources Management")
```

Management
--------------------------------------------------------------------------------
```{r}
mgt <- getmerge_outcomes("Management")
make_graph(mgt, "Management")
```

Marketing
--------------------------------------------------------------------------------

MBA
--------------------------------------------------------------------------------
```{r}
mba <- getmerge_outcomes("MBA", grad = TRUE)
make_graph(mba, "MBA")
```

MIS
--------------------------------------------------------------------------------

Next
================================================================================
